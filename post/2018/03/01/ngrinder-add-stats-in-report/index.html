<!doctype html>

<html lang="zh-cn">

<head>
  <title>Haunted Hovel - 闹鬼小屋</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="Keith Mo" />
  <meta name="generator" content="Hugo 0.36" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="/css/styles.css" />
</head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="/">Haunted Hovel - 闹鬼小屋</a>
            </h1>

      <ul id="social-media">
          
        <li><a href="https://github.com/keithmork"><i class="fa fa-github fa-lg" aria-hidden="true"></i></a></li>
           
      </ul>
      
      <p><em>本站采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用(BY-NC) 4.0 国际许可协议</a> 进行许可。</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="/post/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="/guide/">
                <i class="fa-li fa  fa-lg"></i><span>Guides</span>
            </a>
        </li>
        
        <li>
            <a class="" href="/links/">
                <i class="fa-li fa  fa-lg"></i><span>Links</span>
            </a>
        </li>
        
        <li>
            <a class="" href="/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>nGrinder 改造 - 在详细报告里增加更多统计项</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2018-03-01T02:25:25&#43;08:00">Mar 1, 2018</time>
        </li>
        
        
        <li>
            Categories: 
            <em>
                
                    
                    <a href="/categories/10000-Hours/">10000 Hours</a>
                
            </em>
        </li>
        

        
        <li>
            <em>
                
                    
                    <a href="/tags/Performance/">#Performance</a>
                
                    , 
                    <a href="/tags/Load-Test/">#Load Test</a>
                
                    , 
                    <a href="/tags/nGrinder/">#nGrinder</a>
                
            </em>
        </li>
        

        <li>3 min read</li>
    </ul>
</aside>
    

    

<h3 id="背景">背景</h3>

<p>nGrinder 以轻量、容易上手、容易扩展的特点在众多性能测试工具中脱颖而出，受到不少公司追捧。其实它的缺点也相当明显，更适合作为交给开发自测的工具。</p>

<p>其中有一项几乎一票否决的重大缺陷就是报告里只统计了平均响应时间——凡是不按百分位数统计的工具都是耍流氓，也就能拿去忽悠人，对发现和定位问题帮助不大。</p>

<p>幸好网上已经有人给出了详细的改造方法：</p>

<blockquote>
<p><a href="https://testerhome.com/topics/4225">nGrinder 项目剖析及二次开发</a>, neven7 (胡刚), 2016-02</p>
</blockquote>

<p>下面的代码基本照搬自原帖，删了一些开发通常不感兴趣的字段，改了部分名字。在 nGrinder 3.4.1 测试通过。</p>

<hr />

<p>首先，到官方repo <a href="https://github.com/naver/ngrinder">https://github.com/naver/ngrinder</a> 克隆源码到本地：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git clone git@github.com:naver/ngrinder.git</code></pre></div>
<h3 id="0-添加依赖包">0. 添加依赖包</h3>

<p>在 <code>ngrinder-core</code> 下的 <code>pom.xml</code> 中添加 commons-math3：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#062873;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;groupId&gt;</span>org.apache.commons<span style="color:#062873;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;artifactId&gt;</span>commons-math3<span style="color:#062873;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;version&gt;</span>3.4<span style="color:#062873;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#062873;font-weight:bold">&lt;/dependency&gt;</span></code></pre></div>
<h3 id="1-修改-controller-层">1. 修改 Controller 层</h3>

<p>在 <code>ngrinder-core/src/main/java/net/grinder/SingleConsole.java</code> 中搜 <code>updateStatistics</code> 方法：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">// 添加成员变量：
</span><span style="color:#60a0b0;font-style:italic"></span>
<span style="color:#007020;font-weight:bold">private</span> List<span style="color:#666">&lt;</span>Double<span style="color:#666">&gt;</span> responseTimeList <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> CopyOnWriteArrayList<span style="color:#666">&lt;</span>Double<span style="color:#666">&gt;();</span>

<span style="color:#60a0b0;font-style:italic">// 修改这方法：
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">protected</span> <span style="color:#902000">void</span> <span style="color:#06287e">updateStatistics</span><span style="color:#666">(</span>StatisticsSet intervalStatistics<span style="color:#666">,</span> StatisticsSet accumulatedStatistics<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#60a0b0;font-style:italic">// 找到这里：
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">for</span> <span style="color:#666">(</span>Entry<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> StatisticExpression<span style="color:#666">&gt;</span> each <span style="color:#666">:</span> getExpressionEntrySet<span style="color:#666">())</span> <span style="color:#666">{</span>
        <span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#60a0b0;font-style:italic">// 添加以下内容，收集所有响应时间记录：
</span><span style="color:#60a0b0;font-style:italic"></span>        
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#4070a0">&#34;Mean_Test_Time_(ms)&#34;</span><span style="color:#666">.</span><span style="color:#4070a0">equals</span><span style="color:#666">(</span>each<span style="color:#666">.</span><span style="color:#4070a0">getKey</span><span style="color:#666">()))</span> <span style="color:#666">{</span>
            responseTimeList<span style="color:#666">.</span><span style="color:#4070a0">add</span><span style="color:#666">((</span>Double<span style="color:#666">)</span> getRealDoubleValue<span style="color:#666">(</span>each<span style="color:#666">.</span><span style="color:#4070a0">getValue</span><span style="color:#666">()</span>
                <span style="color:#666">.</span><span style="color:#4070a0">getDoubleValue</span><span style="color:#666">(</span>intervalStatistics<span style="color:#666">)));</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
    
    <span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">}</span></code></pre></div>
<p>添加以下方法，统计各个百分位数的响应时间：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">void</span> <span style="color:#06287e">getAdditionalStats</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>LOGGER<span style="color:#666">.</span><span style="color:#4070a0">isDebugEnabled</span><span style="color:#666">())</span> <span style="color:#666">{</span>
        LOGGER<span style="color:#666">.</span><span style="color:#4070a0">debug</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;getAdditionalStats() responseTimeList is {}&#34;</span><span style="color:#666">,</span> responseTimeList<span style="color:#666">.</span><span style="color:#4070a0">toString</span><span style="color:#666">());</span>
    <span style="color:#666">}</span>

    <span style="color:#60a0b0;font-style:italic">// list to array
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#902000">int</span> i <span style="color:#666">=</span> 0<span style="color:#666">;</span>
    <span style="color:#902000">double</span><span style="color:#666">[]</span> rtArray <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> <span style="color:#902000">double</span><span style="color:#666">[</span>responseTimeList<span style="color:#666">.</span><span style="color:#4070a0">size</span><span style="color:#666">()];</span>
    <span style="color:#007020;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#902000">double</span> responseTime <span style="color:#666">:</span> responseTimeList<span style="color:#666">)</span> <span style="color:#666">{</span>
        rtArray<span style="color:#666">[</span>i<span style="color:#666">++]</span> <span style="color:#666">=</span> responseTime<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    Arrays<span style="color:#666">.</span><span style="color:#4070a0">sort</span><span style="color:#666">(</span>rtArray<span style="color:#666">);</span>

    Percentile percentile <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Percentile<span style="color:#666">();</span>
    Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> additionalStats <span style="color:#666">=</span> newHashMap<span style="color:#666">();</span>
    additionalStats<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;minRT&#34;</span><span style="color:#666">,</span> rtArray<span style="color:#666">[</span>0<span style="color:#666">]);</span>
    additionalStats<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;pct25RT&#34;</span><span style="color:#666">,</span> percentile<span style="color:#666">.</span><span style="color:#4070a0">evaluate</span><span style="color:#666">(</span>rtArray<span style="color:#666">,</span> 25<span style="color:#666">));</span>
    additionalStats<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;pct50RT&#34;</span><span style="color:#666">,</span> percentile<span style="color:#666">.</span><span style="color:#4070a0">evaluate</span><span style="color:#666">(</span>rtArray<span style="color:#666">,</span> 50<span style="color:#666">));</span>
    additionalStats<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;pct75RT&#34;</span><span style="color:#666">,</span> percentile<span style="color:#666">.</span><span style="color:#4070a0">evaluate</span><span style="color:#666">(</span>rtArray<span style="color:#666">,</span> 75<span style="color:#666">));</span>
    additionalStats<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;pct90RT&#34;</span><span style="color:#666">,</span> percentile<span style="color:#666">.</span><span style="color:#4070a0">evaluate</span><span style="color:#666">(</span>rtArray<span style="color:#666">,</span> 90<span style="color:#666">));</span>
    additionalStats<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;pct95RT&#34;</span><span style="color:#666">,</span> percentile<span style="color:#666">.</span><span style="color:#4070a0">evaluate</span><span style="color:#666">(</span>rtArray<span style="color:#666">,</span> 95<span style="color:#666">));</span>
    additionalStats<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;pct99RT&#34;</span><span style="color:#666">,</span> percentile<span style="color:#666">.</span><span style="color:#4070a0">evaluate</span><span style="color:#666">(</span>rtArray<span style="color:#666">,</span> 99<span style="color:#666">));</span>
    additionalStats<span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;maxRT&#34;</span><span style="color:#666">,</span> rtArray<span style="color:#666">[</span>rtArray<span style="color:#666">.</span><span style="color:#4070a0">length</span> <span style="color:#666">-</span> 1<span style="color:#666">]);</span>

    LOGGER<span style="color:#666">.</span><span style="color:#4070a0">debug</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;SingleConsole getAdditionalStats additionalStats {}&#34;</span><span style="color:#666">,</span> additionalStats<span style="color:#666">);</span>

    <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">statisticData</span><span style="color:#666">.</span><span style="color:#4070a0">put</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;additionalStats&#34;</span><span style="color:#666">,</span> additionalStats<span style="color:#666">);</span>
<span style="color:#666">}</span></code></pre></div>
<p>修改以下方法：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">unregisterSampling</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    <span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#60a0b0;font-style:italic">// 在最后调用上面的方法，采样结束后处理数据：
</span><span style="color:#60a0b0;font-style:italic"></span>
    getAdditionalStats<span style="color:#666">();</span>
<span style="color:#666">}</span></code></pre></div>
<hr />

<h3 id="2-修改-model-层">2. 修改 Model 层</h3>

<p>编辑 <code>ngrinder-core/src/main/java/org/ngrinder/model/PerfTest.java</code>，添加以下字段：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">// followings are test result members
</span><span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic"></span>
<span style="color:#555;font-weight:bold">@Expose</span>
<span style="color:#555;font-weight:bold">@Column</span><span style="color:#666">(</span>name <span style="color:#666">=</span> <span style="color:#4070a0">&#34;minRT&#34;</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:bold">private</span> Double minRT<span style="color:#666">;</span>

<span style="color:#555;font-weight:bold">@Expose</span>
<span style="color:#555;font-weight:bold">@Column</span><span style="color:#666">(</span>name <span style="color:#666">=</span> <span style="color:#4070a0">&#34;pct25RT&#34;</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:bold">private</span> Double pct25RT<span style="color:#666">;</span>

<span style="color:#555;font-weight:bold">@Expose</span>
<span style="color:#555;font-weight:bold">@Column</span><span style="color:#666">(</span>name <span style="color:#666">=</span> <span style="color:#4070a0">&#34;pct50RT&#34;</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:bold">private</span> Double pct50RT<span style="color:#666">;</span>

<span style="color:#555;font-weight:bold">@Expose</span>
<span style="color:#555;font-weight:bold">@Column</span><span style="color:#666">(</span>name <span style="color:#666">=</span> <span style="color:#4070a0">&#34;pct75RT&#34;</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:bold">private</span> Double pct75RT<span style="color:#666">;</span>

<span style="color:#555;font-weight:bold">@Expose</span>
<span style="color:#555;font-weight:bold">@Column</span><span style="color:#666">(</span>name <span style="color:#666">=</span> <span style="color:#4070a0">&#34;pct90RT&#34;</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:bold">private</span> Double pct90RT<span style="color:#666">;</span>

<span style="color:#555;font-weight:bold">@Expose</span>
<span style="color:#555;font-weight:bold">@Column</span><span style="color:#666">(</span>name <span style="color:#666">=</span> <span style="color:#4070a0">&#34;pct95RT&#34;</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:bold">private</span> Double pct95RT<span style="color:#666">;</span>

<span style="color:#555;font-weight:bold">@Expose</span>
<span style="color:#555;font-weight:bold">@Column</span><span style="color:#666">(</span>name <span style="color:#666">=</span> <span style="color:#4070a0">&#34;pct99RT&#34;</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:bold">private</span> Double pct99RT<span style="color:#666">;</span>

<span style="color:#555;font-weight:bold">@Expose</span>
<span style="color:#555;font-weight:bold">@Column</span><span style="color:#666">(</span>name <span style="color:#666">=</span> <span style="color:#4070a0">&#34;maxRT&#34;</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:bold">private</span> Double maxRT<span style="color:#666">;</span>

<span style="color:#666">//</span> 再加上对应的 getter 和 setter <span style="">（</span>IDEA 按 cmd <span style="color:#666">+</span> N<span style="">，</span>或右键 <span style="color:#666">-&gt;</span> Generate<span style="color:#666">...</span><span style="">）</span></code></pre></div>
<h4 id="修改-db-保存字段">修改 DB 保存字段</h4>

<p>编辑 <code>ngrinder-controller/src/main/resources/ngrinder_datachange_logfile/db.changelog_schema_H2.xml</code>，在对应位置添加上面的字段：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">create table <span style="color:#06287e">PERF_TEST</span> <span style="color:#666">(</span>
    <span style="color:#60a0b0;font-style:italic">/* ... 
</span><span style="color:#60a0b0;font-style:italic">    peak_tps double, */</span>
    errorRate <span style="color:#902000">double</span><span style="color:#666">,</span>
    minRT <span style="color:#902000">double</span><span style="color:#666">,</span>
    pct25RT <span style="color:#902000">double</span><span style="color:#666">,</span>
    pct50RT <span style="color:#902000">double</span><span style="color:#666">,</span>
    pct75RT <span style="color:#902000">double</span><span style="color:#666">,</span>
    pct90RT <span style="color:#902000">double</span><span style="color:#666">,</span>
    pct95RT <span style="color:#902000">double</span><span style="color:#666">,</span>
    pct99RT <span style="color:#902000">double</span><span style="color:#666">,</span>
    maxRT <span style="color:#902000">double</span><span style="color:#666">,</span>
    <span style="color:#60a0b0;font-style:italic">/*port integer,
</span><span style="color:#60a0b0;font-style:italic">    ... */</span>
<span style="color:#666">)</span></code></pre></div>
<hr />

<h3 id="3-修改-service-层">3. 修改 Service 层</h3>

<p>在 <code>ngrinder-controller/src/main/java/org/ngrinder/perftest/service/PerfTestService.java</code> 中搜 <code>updatePerfTestAfterTestFinish</code> 方法，这里会从 SingleConsole 类中获取刚才的 statisticData。</p>

<p>在对应位置添加以下内容：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">updatePerfTestAfterTestFinish</span><span style="color:#666">(</span>PerfTest perfTest<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#60a0b0;font-style:italic">//Map&lt;String, Object&gt; totalStatistics = MapUtils.getMap( ...
</span><span style="color:#60a0b0;font-style:italic"></span>    
    <span style="color:#555;font-weight:bold">@SuppressWarnings</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;unchecked&#34;</span><span style="color:#666">)</span>
    Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> additionalStats <span style="color:#666">=</span> MapUtils<span style="color:#666">.</span><span style="color:#4070a0">getMap</span><span style="color:#666">(</span>result<span style="color:#666">,</span> <span style="color:#4070a0">&#34;additionalStats&#34;</span><span style="color:#666">,</span> MapUtils<span style="color:#666">.</span><span style="color:#4070a0">EMPTY_MAP</span><span style="color:#666">);</span>
    
    <span style="color:#60a0b0;font-style:italic">//LOGGER.info(&#34;Total Statistics ...
</span><span style="color:#60a0b0;font-style:italic"></span>    LOGGER<span style="color:#666">.</span><span style="color:#4070a0">info</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;Additional Statistics for test {}  is {}&#34;</span><span style="color:#666">,</span> perfTest<span style="color:#666">.</span><span style="color:#4070a0">getId</span><span style="color:#666">(),</span> additionalStats<span style="color:#666">);</span>
    
    <span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic"></span>    
    perfTest<span style="color:#666">.</span><span style="color:#4070a0">setMinRT</span><span style="color:#666">(</span>parseDoubleWithSafety<span style="color:#666">(</span>additionalStats<span style="color:#666">,</span> <span style="color:#4070a0">&#34;minRT&#34;</span><span style="color:#666">,</span> 0D<span style="color:#666">));</span>
    perfTest<span style="color:#666">.</span><span style="color:#4070a0">setPct25RT</span><span style="color:#666">(</span>parseDoubleWithSafety<span style="color:#666">(</span>additionalStats<span style="color:#666">,</span> <span style="color:#4070a0">&#34;pct25RT&#34;</span><span style="color:#666">,</span> 0D<span style="color:#666">));</span>
    perfTest<span style="color:#666">.</span><span style="color:#4070a0">setPct50RT</span><span style="color:#666">(</span>parseDoubleWithSafety<span style="color:#666">(</span>additionalStats<span style="color:#666">,</span> <span style="color:#4070a0">&#34;pct50RT&#34;</span><span style="color:#666">,</span> 0D<span style="color:#666">));</span>
    perfTest<span style="color:#666">.</span><span style="color:#4070a0">setPct75RT</span><span style="color:#666">(</span>parseDoubleWithSafety<span style="color:#666">(</span>additionalStats<span style="color:#666">,</span> <span style="color:#4070a0">&#34;pct75RT&#34;</span><span style="color:#666">,</span> 0D<span style="color:#666">));</span>
    perfTest<span style="color:#666">.</span><span style="color:#4070a0">setPct90RT</span><span style="color:#666">(</span>parseDoubleWithSafety<span style="color:#666">(</span>additionalStats<span style="color:#666">,</span> <span style="color:#4070a0">&#34;pct90RT&#34;</span><span style="color:#666">,</span> 0D<span style="color:#666">));</span>
    perfTest<span style="color:#666">.</span><span style="color:#4070a0">setPct95RT</span><span style="color:#666">(</span>parseDoubleWithSafety<span style="color:#666">(</span>additionalStats<span style="color:#666">,</span> <span style="color:#4070a0">&#34;pct95RT&#34;</span><span style="color:#666">,</span> 0D<span style="color:#666">));</span>
    perfTest<span style="color:#666">.</span><span style="color:#4070a0">setPct99RT</span><span style="color:#666">(</span>parseDoubleWithSafety<span style="color:#666">(</span>additionalStats<span style="color:#666">,</span> <span style="color:#4070a0">&#34;pct99RT&#34;</span><span style="color:#666">,</span> 0D<span style="color:#666">));</span>
    perfTest<span style="color:#666">.</span><span style="color:#4070a0">setMaxRT</span><span style="color:#666">(</span>parseDoubleWithSafety<span style="color:#666">(</span>additionalStats<span style="color:#666">,</span> <span style="color:#4070a0">&#34;maxRT&#34;</span><span style="color:#666">,</span> 0D<span style="color:#666">));</span>
<span style="color:#666">}</span></code></pre></div>
<hr />

<h3 id="4-修改-view-层">4. 修改 View 层</h3>

<p>编辑 <code>ngrinder-controller/src/main/webapp/WEB-INF/ftl/perftest/detail_report.ftl</code>，在对应位置添加：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#062873;font-weight:bold">&lt;table</span> <span style="color:#4070a0">class=</span><span style="color:#4070a0">&#34;table table-bordered compactpadding&#34;</span><span style="color:#062873;font-weight:bold">&gt;</span>
    <span style="color:#60a0b0;font-style:italic">&lt;!-- ... --&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.errorRate&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${(test.errors /(test.tests + test.errors))!&#34;&#34;}<span style="color:#062873;font-weight:bold">&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.minRT&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${test.minRT!&#34;&#34;}<span style="color:#d55537;font-weight:bold">&amp;nbsp;&amp;nbsp;</span> <span style="color:#062873;font-weight:bold">&lt;code&gt;</span>ms<span style="color:#062873;font-weight:bold">&lt;/code&gt;&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.pct25RT&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${test.pct25RT!&#34;&#34;}<span style="color:#d55537;font-weight:bold">&amp;nbsp;&amp;nbsp;</span> <span style="color:#062873;font-weight:bold">&lt;code&gt;</span>ms<span style="color:#062873;font-weight:bold">&lt;/code&gt;&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.pct50RT&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${test.pct50RT!&#34;&#34;}<span style="color:#d55537;font-weight:bold">&amp;nbsp;&amp;nbsp;</span> <span style="color:#062873;font-weight:bold">&lt;code&gt;</span>ms<span style="color:#062873;font-weight:bold">&lt;/code&gt;&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.pct75RT&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${test.pct75RT!&#34;&#34;}<span style="color:#d55537;font-weight:bold">&amp;nbsp;&amp;nbsp;</span> <span style="color:#062873;font-weight:bold">&lt;code&gt;</span>ms<span style="color:#062873;font-weight:bold">&lt;/code&gt;&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.pct90RT&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${test.pct90RT!&#34;&#34;}<span style="color:#d55537;font-weight:bold">&amp;nbsp;&amp;nbsp;</span> <span style="color:#062873;font-weight:bold">&lt;code&gt;</span>ms<span style="color:#062873;font-weight:bold">&lt;/code&gt;&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.pct95RT&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${test.pct95RT!&#34;&#34;}<span style="color:#d55537;font-weight:bold">&amp;nbsp;&amp;nbsp;</span> <span style="color:#062873;font-weight:bold">&lt;code&gt;</span>ms<span style="color:#062873;font-weight:bold">&lt;/code&gt;&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.pct99RT&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${test.pct99RT!&#34;&#34;}<span style="color:#d55537;font-weight:bold">&amp;nbsp;&amp;nbsp;</span> <span style="color:#062873;font-weight:bold">&lt;code&gt;</span>ms<span style="color:#062873;font-weight:bold">&lt;/code&gt;&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;tr&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;th&gt;</span><span style="">&lt;</span>@spring.message &#34;perfTest.report.maxRT&#34;/&gt;<span style="color:#062873;font-weight:bold">&lt;/th&gt;</span>
        <span style="color:#062873;font-weight:bold">&lt;td&gt;</span>${test.maxRT!&#34;&#34;}<span style="color:#d55537;font-weight:bold">&amp;nbsp;&amp;nbsp;</span> <span style="color:#062873;font-weight:bold">&lt;code&gt;</span>ms<span style="color:#062873;font-weight:bold">&lt;/code&gt;&lt;/td&gt;</span>
    <span style="color:#062873;font-weight:bold">&lt;/tr&gt;</span>
<span style="color:#062873;font-weight:bold">&lt;/table&gt;</span></code></pre></div>
<hr />

<h3 id="5-修改不同语言的ui显示文字">5. 修改不同语言的UI显示文字</h3>

<p>在 <code>ngrinder-controller/src/main/resources</code> 下找到以下文件，在对应位置添加如下内容：</p>

<p>messages_cn.properties</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic">//perfTest.report.errors=Errors
</span><span style="color:#60a0b0;font-style:italic"></span>perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">errorRate</span><span style="color:#666">=</span><span style="">\</span>u9519<span style="">\</span>u8bef<span style="">\</span>u7387
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">minRT</span><span style="color:#666">=</span><span style="">\</span>u6700<span style="">\</span>u5c0f RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct25RT</span><span style="color:#666">=</span>25 <span style="">\</span>u767e<span style="">\</span>u5206<span style="">\</span>u4f4d<span style="">\</span>u6570 RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct50RT</span><span style="color:#666">=</span>50 <span style="">\</span>u767e<span style="">\</span>u5206<span style="">\</span>u4f4d<span style="">\</span>u6570 RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct75RT</span><span style="color:#666">=</span>75 <span style="">\</span>u767e<span style="">\</span>u5206<span style="">\</span>u4f4d<span style="">\</span>u6570 RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct90RT</span><span style="color:#666">=</span>90 <span style="">\</span>u767e<span style="">\</span>u5206<span style="">\</span>u4f4d<span style="">\</span>u6570 RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct95RT</span><span style="color:#666">=</span>95 <span style="">\</span>u767e<span style="">\</span>u5206<span style="">\</span>u4f4d<span style="">\</span>u6570 RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct99RT</span><span style="color:#666">=</span>99 <span style="">\</span>u767e<span style="">\</span>u5206<span style="">\</span>u4f4d<span style="">\</span>u6570 RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">maxRT</span><span style="color:#666">=</span><span style="">\</span>u6700<span style="">\</span>u5927 RT
<span style="color:#666">//</span> <span style="color:#666">...</span></code></pre></div>
<p>messages_en.properties</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">// ...
</span><span style="color:#60a0b0;font-style:italic">//perfTest.report.errors=Errors
</span><span style="color:#60a0b0;font-style:italic"></span>perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">errorRate</span><span style="color:#666">=</span>Error Rate
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">minRT</span><span style="color:#666">=</span>Min RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct25RT</span><span style="color:#666">=</span>25th Pct RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct50RT</span><span style="color:#666">=</span>50th Pct RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct75RT</span><span style="color:#666">=</span>75th Pct RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct90RT</span><span style="color:#666">=</span>90th Pct RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct95RT</span><span style="color:#666">=</span>95th Pct RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">pct99RT</span><span style="color:#666">=</span>99th Pct RT
perfTest<span style="color:#666">.</span><span style="color:#4070a0">report</span><span style="color:#666">.</span><span style="color:#4070a0">maxRT</span><span style="color:#666">=</span>Max RT
<span style="color:#666">//</span> <span style="color:#666">...</span></code></pre></div>
<hr />

<h3 id="6-打包">6. 打包</h3>

<p>有几个依赖的 jar 包在 Maven 仓库找不到，到这里下：</p>

<ul>
<li><a href="https://github.com/naver/nhnopensource.maven.repo/tree/master/releases/grinder/grinder-patch/3.9.1-patch">https://github.com/naver/nhnopensource.maven.repo/tree/master/releases/grinder/grinder-patch/3.9.1-patch</a></li>
<li><a href="https://github.com/naver/nhnopensource.maven.repo/tree/master/releases/org/ngrinder/universal-analytics-java/1.0">https://github.com/naver/nhnopensource.maven.repo/tree/master/releases/org/ngrinder/universal-analytics-java/1.0</a></li>
<li><a href="https://github.com/naver/nhnopensource.maven.repo/tree/master/releases/sigar/sigar-native/1.0">https://github.com/naver/nhnopensource.maven.repo/tree/master/releases/sigar/sigar-native/1.0</a></li>
</ul>

<p>放到 <code>~/.m2/repository</code> 下对应的目录，如 <code>grinder/grinder-patch/3.9.1-patch</code>。</p>

<p>检查依赖：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mvn -Dmaven.test.skip<span style="color:#666">=</span><span style="color:#007020">true</span> dependency:analyze
mvn -Dmaven.test.skip<span style="color:#666">=</span><span style="color:#007020">true</span> dependency:resolve</code></pre></div>
<p>如果包已经放到指定地方，IDEA 的项目设置（F4）里没报错，但 Maven 面板依然显示有依赖错误，重启 IDEA 试试。</p>

<p>没报错就打包：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mvn -Dmaven.test.skip<span style="color:#666">=</span><span style="color:#007020">true</span> clean package</code></pre></div>
<p>找到 <code>ngrinder-controller/ngrinder-controller-&lt;version&gt;-SNAPSHOT.war</code>，拿去运行。</p>

<h4 id="注意">注意</h4>

<p>如果之前已经运行过原版 nGrinder，会在 <code>~/.ngrinder/db</code> 里保存了数据。由于表加了字段，跟原来的数据不兼容，启动会报错。</p>

<p>把 <code>~/.ngrinder/db</code> 目录删掉，重新运行程序就好。</p>

<hr />

<h3 id="效果">效果</h3>

<p>中文界面</p>

<p><img src="http://keithmo.me/img/post/2018/02/28/ngrinder-report-cn.jpg" alt="详细测试结果截图-中文" /></p>

<p>英文界面</p>

<p><img src="http://keithmo.me/img/post/2018/02/28/ngrinder-report-en.jpg" alt="详细测试结果截图-英文" /></p>

<hr />

<p><img src="http://keithmo.me/img/wechat_reward_qrcode.png" alt="微信打赏二维码" /></p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="http://keithmo.me/post/2017/12/16/jmeter-grafana-dashboard/"><i class="fa fa-chevron-circle-left"></i> JMeter 实时监控仪表板配置 (Grafana &#43; InfluxDB)</a>
        </li>
        
        
    </ul>
</section>
    
        <section class="comments-block">
      <button id="show-comments" style="display: none;"><i class="fa fa-comments-o"></i> Add/View Comments</button>
</section>

<section id="disqus_thread"></section>

<script>
      (function () {
            
            
            if (window.location.hostname == "localhost")
                  return;

            var disqus_loaded = false;
            var disqus_shortname = 'keithmo';
            var disqus_button = document.getElementById("show-comments");

            disqus_button.style.display = "";
            disqus_button.addEventListener("click", disqus, false);

            function disqus() {

                  if (!disqus_loaded) {
                        disqus_loaded = true;

                        var e = document.createElement("script");
                        e.type = "text/javascript";
                        e.async = true;
                        e.src = "//" + disqus_shortname + ".disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] ||
                              document.getElementsByTagName("body")[0])
                        .appendChild(e);

                        
                        document.getElementById("show-comments").style.display = "none";
                  }
            }

            
            var hash = window.location.hash.substr(1);
            if (hash.length > 8) {
                  if (hash.substring(0, 8) == "comment-") {
                        disqus();
                  }
            }

            
            if (/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)) {
                  disqus();
            }
      })();
</script>
    





</main>
    <footer>
        <h6>Copyright &copy; 2016-2018 - Keith Mo | 
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="http://keithmo.me/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="/js/scripts.js"></script>
</body>

</html>